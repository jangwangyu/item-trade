<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">ê²Œì‹œë¬¼ ìƒì„¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body th:replace="~{layout :: layout(~{::section})}">

<section style="background-color: #f8f9fa; padding: 2rem; border-radius: 0.5rem;">
  <div class="row">
    <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
    <div class="col-md-6 mb-3" th:if="${post.imagePaths != null}">
      <div class="d-flex flex-wrap gap-2">
        <img th:each="image : ${post.imagePaths}"
             th:src="@{${image.imagePath()}}"
             class="img-fluid rounded"
             style="width: 200px; height: 200px; object-fit: cover; border-radius: 10px;">
      </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ -->
    <div class="col-md-6">
      <h3 th:text="${post.title}" class="fw-bold mb-3">ì•„ì´í…œ ì œëª©</h3>
      <p>
        <span class="badge bg-secondary mb-2" th:text="${post.getCategoryDisplayName}">ì¹´í…Œê³ ë¦¬</span>
      </p>
      <p class="mb-2" th:text="'ì‘ì„±ì: ' + ${post.sellerNickname()}">ì‘ì„±ì</p>
      <p class="mb-2 text-primary fs-4 fw-semibold">
        <span th:if="${post.price != null}" th:text="${#numbers.formatInteger(post.price, 3, 'COMMA') + 'ì›'}">50,000ì›</span>
        <span th:if="${post.price == null}">ê°€ê²© ë¯¸ì •</span>
      </p>
      <p class="mb-4" th:text="${post.description}">ì•„ì´í…œ ì„¤ëª…</p>

      <!-- ë²„íŠ¼ ì˜ì—­ -->
      <div class="d-flex gap-2">
        <form th:if="${!isAuthor}" th:action="@{'/chat/' + ${post.id}}" method="post">
          <button type="submit" class="btn btn-outline-success">ì±„íŒ…í•˜ê¸°</button>
        </form>
        <a th:if="${isAuthor}" th:href="@{'/posts/edit/' + ${post.id}}" class="btn btn-outline-primary">ìˆ˜ì •</a>

        <form th:action="@{${post.id} + '/delete'}" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" method="post">
          <input type="hidden" name="_method" value="delete"/>
          <button type="submit" th:if="${isAuthor}" class="btn btn-danger">ì‚­ì œ</button>
        </form>

      </div>
    </div>
  </div>

  <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
  <div class="mt-5">
    <h5 class="mb-3">ëŒ“ê¸€</h5>

    <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ (AJAXë¡œ ì±„ì›€) -->
    <div id="comment-box" class="list-group mb-4"></div>

    <!-- ëŒ“ê¸€ ì‘ì„± í¼ (AJAX ì „ì†¡) -->
    <form id="comment-form" class="d-flex flex-column gap-2">
      <label>
        <textarea name="content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </label>
      <button type="submit" class="btn btn-primary align-self-end">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
    <button id="load-more" class="btn btn-secondary">ë”ë³´ê¸°</button>
  </div>


</section>

</body>

<script th:inline="javascript">
  const postId = [[${post.id}]];
  const currentUserId = [[${currentUserId}]];
  let currentPage = 0;

  function loadComments() {
    fetch(`/api/comments/${postId}?page=${currentPage}`)
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById("comment-box");

      // í˜ì´ì§€ 0ì¼ ë•Œë§Œ ì „ì²´ ì´ˆê¸°í™” (ì‘ì„± ì§í›„ or ì´ˆê¸° ë¡œë”©)
      if (currentPage === 0) box.innerHTML = "";

      data.content.forEach(comment => {
        const isMine = comment.writerId === currentUserId;
        box.innerHTML += `
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <strong>${comment.writerNickname}</strong>
                <small class="text-muted">${comment.createdAt.replace('T', ' ').slice(0, 16)}</small>
              </div>
              <p class="mb-0">${comment.content}</p>
              ${isMine ? `
                <button onclick="deleteComment(${comment.id})"
                        class="btn btn-sm btn-outline-danger mt-2">ì‚­ì œ</button>` : ''}
            </div>
          `;
      });

      // ë‹¤ìŒ í˜ì´ì§€ ëŒ€ë¹„
      if (!data.last) {
        currentPage += 1;
        document.getElementById("load-more").style.display = "block";
      } else {
        document.getElementById("load-more").style.display = "none";
      }
    });
  }

  function writeComment() {
    const textarea = document.querySelector("textarea[name='content']");
    const content = textarea.value.trim();
    if (!content) return;

    fetch(`/api/comments/${postId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content })
    })
    .then(res => res.json())
    .then(() => {
      textarea.value = "";

      // ëŒ“ê¸€ ë‹¤ì‹œ ì²˜ìŒë¶€í„° ë¶ˆëŸ¬ì˜¤ê¸°
      currentPage = 0;
      loadComments();
    });

    console.log("ğŸ“¦ content ë‚´ìš©:", content);
  }

  function deleteComment(commentId) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch(`/api/comments/${commentId}`, {
      method: "DELETE"
    }).then(() => {
      currentPage = 0;
      loadComments();
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadComments();

    document.getElementById("comment-form").addEventListener("submit", e => {
      e.preventDefault();
      writeComment();
    });

    document.getElementById("load-more").addEventListener("click", loadComments);
  });
</script>


</html>
